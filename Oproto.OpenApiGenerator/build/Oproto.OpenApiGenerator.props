<Project>
  <PropertyGroup>
    <OpenApiGeneratorTasksPath>$(MSBuildThisFileDirectory)</OpenApiGeneratorTasksPath>
  </PropertyGroup>

  <!-- Update to use the source generator -->
  <ItemGroup>
    <CompilerVisibleItemMetadata Include="AdditionalFiles" MetadataName="OpenApiGenerator"/>
    <SourceGenerator Include="$(MSBuildThisFileDirectory)..\analyzers\dotnet\cs\Oproto.OpenApiGenerator.dll"/>
  </ItemGroup>

  <!-- Reference required assemblies -->
  <ItemGroup>
    <Reference Include="Oproto.OpenApi">
      <HintPath>$(MSBuildThisFileDirectory)..\lib\netstandard2.0\Oproto.OpenApi.dll</HintPath>
      <Private>true</Private>
    </Reference>
  </ItemGroup>

  <ItemGroup>
    <None Include="$(MSBuildThisFileDirectory)..\lib\netstandard2.0\Oproto.OpenApi.dll"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"/>
  </ItemGroup>

  <PropertyGroup>
    <TasksAssemblyPath>$(MSBuildThisFileDirectory)Oproto.OpenApiGenerator.Tasks.dll</TasksAssemblyPath>
  </PropertyGroup>

  <ItemGroup>
    <Reference Include="Oproto.OpenApi">
      <HintPath>$(MSBuildThisFileDirectory)Oproto.OpenApi.dll</HintPath>
    </Reference>
  </ItemGroup>

  <UsingTask TaskName="Oproto.OpenApiGenerator.Tasks.ExtractOpenApiSpecTask"
             AssemblyFile="$(TasksAssemblyPath)"/>

  <Target Name="GenerateOpenApi"
          AfterTargets="Build">
    <Message Text="Starting OpenAPI Generation" Importance="high"/>

    <ExtractOpenApiSpecTask
      AssemblyPath="$(TargetDir)$(TargetFileName)"
      OutputPath="$(ProjectDir)openapi.json"/>
  </Target>
</Project>
